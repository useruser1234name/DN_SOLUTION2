{% extends 'base.html' %}
{% load static %}

{% block title %}정책 관리 - 스마트기기 판매 정책{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .policy-list-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .filter-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }
    
    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: end;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-outline {
        background: transparent;
        border: 1px solid #007bff;
        color: #007bff;
    }
    
    .policy-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th,
    .table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }
    
    .table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: #2196F3;
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .page-link {
        padding: 8px 12px;
        border: 1px solid #ddd;
        text-decoration: none;
        color: #007bff;
        border-radius: 4px;
    }
    
    .page-link:hover {
        background: #f8f9fa;
    }
    
    .page-current {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="policy-list-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cog"></i> 스마트기기 판매 정책 관리</h1>
        <div class="action-buttons">
            <a href="{% url 'policies:statistics' %}" class="btn btn-outline">
                <i class="fas fa-chart-bar"></i> 통계
            </a>
            {% if user.is_superuser or user_company.type in 'headquarters,agency' %}
            <a href="{% url 'policies:policy_create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> 새 정책 생성
            </a>
            {% endif %}
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search">검색</label>
                    <input type="text" id="search" name="search" value="{{ current_filters.search }}" 
                           placeholder="정책 제목 또는 설명으로 검색">
                </div>
                <div class="filter-group">
                    <label for="form_type">신청서 타입</label>
                    <select id="form_type" name="form_type">
                        <option value="">전체</option>
                        {% for value, label in form_types %}
                        <option value="{{ value }}" {% if current_filters.form_type == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="carrier">통신사</label>
                    <select id="carrier" name="carrier">
                        <option value="">전체</option>
                        {% for value, label in carriers %}
                        <option value="{{ value }}" {% if current_filters.carrier == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="contract_period">가입기간</label>
                    <select id="contract_period" name="contract_period">
                        <option value="">전체</option>
                        {% for value, label in contract_periods %}
                        <option value="{{ value }}" {% if current_filters.contract_period == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="expose">노출 상태</label>
                    <select id="expose" name="expose">
                        <option value="">전체</option>
                        <option value="true" {% if current_filters.expose == 'true' %}selected{% endif %}>노출</option>
                        <option value="false" {% if current_filters.expose == 'false' %}selected{% endif %}>비노출</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="premium_expose">프리미엄 마켓</label>
                    <select id="premium_expose" name="premium_expose">
                        <option value="">전체</option>
                        <option value="true" {% if current_filters.premium_expose == 'true' %}selected{% endif %}>노출</option>
                        <option value="false" {% if current_filters.premium_expose == 'false' %}selected{% endif %}>비노출</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> 검색
                    </button>
                    <a href="{% url 'policies:policy_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> 초기화
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- 정책 목록 테이블 -->
    <div class="policy-table">
        {% if policies %}
        <table class="table">
            <thead>
                <tr>
                    <th>정책 제목</th>
                    <th>신청서 타입</th>
                    <th>통신사</th>
                    <th>가입기간</th>
                    <th>대리점 리베이트</th>
                    <th>판매점 리베이트</th>
                    <th>노출 상태</th>
                    <th>프리미엄 마켓</th>
                    <th>배정 업체</th>
                    <th>생성일</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for policy in policies %}
                <tr>
                    <td>
                        <strong>{{ policy.title }}</strong>
                        {% if policy.description %}
                        <br><small class="text-muted">{{ policy.description|truncatechars:50 }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-active">{{ policy.get_form_type_display }}</span>
                    </td>
                    <td>{{ policy.get_carrier_display }}</td>
                    <td>{{ policy.get_contract_period_display }}</td>
                    <td>{{ policy.rebate_agency|floatformat:0 }}원</td>
                    <td>{{ policy.rebate_retail|floatformat:0 }}원</td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" 
                                   {% if policy.expose %}checked{% endif %}
                                   onchange="toggleExpose('{{ policy.id }}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" 
                                   {% if policy.premium_market_expose %}checked{% endif %}
                                   onchange="togglePremiumExpose('{{ policy.id }}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <a href="{% url 'policies:policy_assignments' policy.pk %}" class="btn btn-sm btn-outline">
                            {{ policy.get_assignment_count }}개 업체
                        </a>
                    </td>
                    <td>{{ policy.created_at|date:"Y-m-d" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'policies:policy_detail' policy.pk %}" class="btn btn-sm btn-primary" title="상세보기">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.is_superuser or user_company.type in 'headquarters,agency' %}
                            <a href="{% url 'policies:policy_deploy' policy.pk %}" class="btn btn-sm btn-success" title="배포">
                                <i class="fas fa-share-alt"></i>
                            </a>
                            <a href="{% url 'policies:policy_update' policy.pk %}" class="btn btn-sm btn-secondary" title="수정">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if user.is_superuser or user_company.type in 'headquarters,agency' %}
                            <button onclick="regenerateHtml('{{ policy.id }}')" class="btn btn-sm btn-outline" title="HTML 재생성">
                                <i class="fas fa-code"></i>
                            </button>
                            <a href="{% url 'policies:policy_delete' policy.pk %}" class="btn btn-sm btn-danger" title="삭제"
                               onclick="return confirm('정말로 이 정책을 삭제하시겠습니까?')">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>등록된 정책이 없습니다</h3>
            <p>새로운 스마트기기 판매 정책을 생성해보세요.</p>
            <a href="{% url 'policies:policy_create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> 첫 번째 정책 생성
            </a>
        </div>
        {% endif %}
    </div>

    <!-- 페이지네이션 -->
    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">
            <i class="fas fa-angle-left"></i>
        </a>
        {% endif %}

        <span class="page-link page-current">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">
            <i class="fas fa-angle-right"></i>
        </a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">
            <i class="fas fa-angle-double-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleExpose(policyId, checked) {
    fetch(`/policies/${policyId}/toggle-expose/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
            // 토글 상태 되돌리기
            event.target.checked = !checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('오류가 발생했습니다.', 'error');
        event.target.checked = !checked;
    });
}

function togglePremiumExpose(policyId, checked) {
    fetch(`/policies/${policyId}/toggle-premium-expose/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
            event.target.checked = !checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('오류가 발생했습니다.', 'error');
        event.target.checked = !checked;
    });
}

function regenerateHtml(policyId) {
    if (!confirm('HTML 내용을 재생성하시겠습니까?')) {
        return;
    }
    
    fetch(`/policies/${policyId}/regenerate-html/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('HTML 재생성 중 오류가 발생했습니다.', 'error');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showMessage(message, type) {
    // 간단한 메시지 표시 (실제 구현에서는 더 정교한 알림 시스템 사용)
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        border-radius: 4px;
        color: white;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    `;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %} 