# 프로젝트 종합 요약 (Project Comprehensive Summary)

`DN_solution` 프로젝트는 Django와 Django REST Framework를 기반으로 구축된 백엔드 시스템으로, 계층적인 업체 및 사용자 관리, 주문 처리, 스마트기기 판매 정책 관리 기능을 제공합니다. 이 문서는 프로젝트의 전반적인 구조, 핵심 기능, 백엔드 및 프론트엔드 전략, 개발 원칙, 그리고 미래 방향에 대한 종합적인 요약을 제공합니다.

## 1. 프로젝트 개요 및 목표

`DN_solution`은 다양한 유형의 업체(본사, 협력사, 판매점)와 그 소속 사용자들을 효율적으로 관리하고, 이들 간의 계층적 관계 및 접근 권한을 체계적으로 제어하는 것을 목표로 합니다. 특히 스마트기기 판매 정책의 효율적인 관리와 웹 노출을 통해 완전한 서비스를 제공합니다. 현재는 RESTful API 백엔드와 Django 템플릿 기반 프론트엔드가 모두 구현되어 있으며, 향후 SPA 프론트엔드 애플리케이션과의 연동을 통해 더욱 완전한 서비스를 제공할 예정입니다.

## 2. 시스템 아키텍처 및 구조

프로젝트는 클라이언트-서버 아키텍처를 따르며, Django 기반의 백엔드 서버와 React 기반의 SPA 프론트엔드로 구성됩니다. 모듈화된 설계를 통해 각 비즈니스 도메인(예: `companies`, `orders`, `policies`)을 독립적인 Django 앱으로 분리하여 유지보수성과 확장성을 확보했습니다.

*   **백엔드:** Django 5.2 (Python 3.13) 및 Django REST Framework를 사용하여 RESTful API를 제공합니다.
*   **인증 시스템:** JWT (JSON Web Token) 기반 토큰 인증으로 클라우드 환경에 최적화된 상태 비저장 인증을 제공합니다.
*   **데이터베이스:** Django ORM을 통해 상호작용하며, SQLite (개발) 또는 PostgreSQL/MySQL (운영)을 지원합니다.
*   **프론트엔드:** React 기반의 SPA (Single Page Application)로 구현되어 있으며, JWT 인증과 계층적 권한 제어를 통한 현대적인 사용자 경험을 제공합니다.
*   **CORS 지원:** `django-cors-headers`를 통해 프론트엔드-백엔드 간 안전한 크로스 도메인 통신을 지원합니다.
*   **문서화:** 모든 프로젝트 문서는 `Docs/` 디렉토리에 체계적으로 정리되어 있습니다.

## 3. 핵심 기능 및 로직

### 3.1. 업체 및 사용자 관리 (`companies` 앱)

*   **계층적 `Company` 모델:** 본사-협력사-판매점의 3단계 계층 구조를 `parent_company` 필드를 통해 구현합니다. `models.py`의 `clean` 메서드를 통해 계층별 생성 규칙(예: 판매점은 반드시 협력사 하위)을 강제하여 데이터 무결성을 보장합니다.
*   **`CompanyUser` 모델:** 각 업체에 소속된 사용자를 `admin` 또는 `staff` 역할로 관리합니다.
*   **계층적 권한 제어:** `companies/utils.py`에 구현된 `get_accessible_company_ids`, `get_visible_companies` 유틸리티 함수를 통해 사용자의 계층에 따른 정밀한 접근 제어를 수행합니다. Django Admin과 API ViewSet 모두에서 동일한 권한 로직을 적용하여 일관성을 보장합니다.
*   **이중 인증 시스템:** Django User와 CompanyUser의 분리된 모델 구조를 통해 시스템 사용자와 업체 사용자를 구분 관리하며, JWT 인증 시 CompanyUser 승인 상태를 검증하여 보안을 강화했습니다.
*   **업체 생성 정책:** 현재 본사는 협력사를 생성할 수 있으며, 유효한 상위 협력사를 지정하는 경우 판매점도 생성 가능합니다. (향후 본사의 판매점 직접 생성 금지 정책 강화 가능).

### 3.2. 주문 관리 (`orders` 앱)

*   **`Order` 모델:** 고객 주문 정보를 개별 필드로 관리 (`customer_name`, `customer_phone`, `customer_email`, `customer_address`), 주문 상태 변경 및 송장 생성 시 자동 업데이트 로직을 포함합니다.
*   **`OrderMemo` 모델:** 주문 처리 과정에서 발생하는 메모를 기록합니다.
*   **`Invoice` 모델:** 송장 정보 관리 및 배송 완료 여부를 추적합니다. `recipient_name`, `recipient_phone` 필드와 `sent_at`, `delivered_at` 시간 추적을 포함합니다.
*   **`OrderRequest` 모델:** 교환, 취소, 반품 요청을 관리하며, `complete()` 메서드로 요청 완료 처리를 지원합니다.

### 3.3. 스마트기기 판매 정책 관리 (`policies` 앱)

*   **`Policy` 모델:** 스마트기기 판매 정책의 핵심 정보를 관리합니다.
    *   **기본 정보:** 제목, 설명, 신청서 타입
    *   **필터링 설정:** 통신사(SKT, KT, LG U+ 등), 가입기간(12개월, 24개월 등)
    *   **리베이트 설정:** 대리점 리베이트, 판매점 리베이트
    *   **노출 설정:** 프론트엔드 노출, 프리미엄 마켓 자동 노출
    *   **자동 HTML 생성:** 정책 데이터 기반 상세페이지 자동 생성
    *   **중복 방지:** 제목 중복 검증 및 방지
*   **`PolicyNotice` 모델:** 정책별 안내사항을 관리합니다.
    *   **안내 유형:** 고객 안내, 업체 공지, 정책 특이사항, 일반 공지
    *   **중요도 설정:** 중요 안내 여부 및 표시 순서 관리
*   **`PolicyAssignment` 모델:** 정책을 특정 업체에 배정하고 커스텀 리베이트를 설정합니다.
    *   **커스텀 리베이트:** 업체별 개별 리베이트 설정
    *   **하위 업체 노출:** 하위 업체에 정책 노출 여부 설정
    *   **효과적 리베이트 계산:** 커스텀 리베이트 우선 적용
    *   **할당된 회사 표시:** `assigned_to_name` 필드를 통해 정책이 할당된 회사의 이름을 명확히 표시
    *   **자식 노드 선택:** 정책 할당 시 자식 노드를 선택할 수 있는 기능 추가

#### 3.3.1. 정책 관리 인터페이스

*   **Django Admin:** 정책, 안내사항, 배정 관리 인터페이스
    *   필터링, 검색, 일괄 작업 지원
    *   안내사항 인라인 편집
    *   통계 정보 제공
*   **웹 인터페이스:** Django 템플릿 기반 사용자 친화적 인터페이스
    *   **정책 목록:** 필터링, 검색, 토글 스위치, 페이지네이션
    *   **정책 생성/수정:** 단계별 입력, 실시간 중복 체크, 유효성 검증
    *   **AJAX 기반 실시간 업데이트:** 노출 상태 토글, HTML 재생성
    *   **자식 노드 선택:** 정책 생성 시 자식 노드를 선택할 수 있는 드롭다운 추가
    *   **할당된 회사 표시:** 정책이 어느 회사에 할당되었는지 명확히 표시

#### 3.3.2. API 엔드포인트

*   **CRUD 작업:** 정책 생성, 조회, 수정, 삭제
*   **상태 관리:** 노출 상태 토글, 프리미엄 마켓 노출 토글
*   **유틸리티:** HTML 재생성, 중복 체크, 통계 조회
*   **관련 데이터:** 안내사항 목록, 배정 업체 목록
*   **자식 회사 목록 API:** 자식 회사 목록을 제공하여 정책 할당 시 선택 가능

## 4. 개발 실천 가이드라인

프로젝트의 모든 코드는 높은 품질과 유지보수성을 위해 다음과 같은 원칙을 준수합니다.

*   **핵심 코딩 원칙:** 단일 책임 원칙(SRP), GoF 디자인 패턴 활용, 애자일 개발 방법론 준수.
*   **클린 코드:** 명확하고 의도적인 이름 지정, `Why`를 설명하는 주석, 로직의 단순화 및 복잡성 제한.
*   **로깅 전략:** `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL` 레벨을 활용하여 모든 과정과 통신 내용을 상세하게 기록합니다. 특히, 테스트 코드 실행 시에도 상세한 로그를 파악할 수 있도록 로깅 설정을 명시합니다.
*   **엣지 케이스 및 예외 처리:** 예상치 못한 상황과 오류를 사전에 식별하고, 모델/시리얼라이저/뷰 레벨의 유효성 검증, `try-except` 블록, 중앙 집중식 오류 처리(DRF `EXCEPTION_HANDLER`)를 통해 안정적으로 처리합니다.
*   **확장성 고려:** 기능, 데이터, 시스템 수준에서의 확장성을 고려하여 모듈화, 추상화, 설정 기반 확장 등을 적용합니다.
*   **테스트 용이성:** 모든 코드는 독립적으로 테스트 가능하도록 설계하며, 충분한 테스트 커버리지를 확보합니다.
*   **협업 및 일관성:** PEP 8 준수, 코드 포매터/린터 사용, 통일된 명명 규칙을 통해 협업 효율을 높입니다.

## 5. UI 접근 제어 전략

백엔드 권한을 시각적으로 반영하고 사용자 경험을 개선하기 위해 프론트엔드에서 역할 기반의 UI 접근 제어를 구현합니다.

*   **조건부 렌더링:** 사용자의 역할에 따라 메뉴, 버튼, 데이터 테이블, 폼 필드 등을 동적으로 표시하거나 숨깁니다.
*   **동적 라우팅/내비게이션:** 라우트 가드를 사용하여 역할에 따른 페이지 접근을 제어합니다.
*   **보안 경고:** UI 제어는 보조적인 보안 계층이며, 백엔드에서의 철저한 권한 검증이 필수적입니다.

## 6. 주요 기술적 성과

### 6.1. JWT 기반 인증 시스템
- **이중 사용자 검증:** Django User + CompanyUser 모델 분리로 시스템 접근과 업무 권한을 이중 검증
- **클라우드 최적화:** 상태 비저장 JWT 토큰으로 분산 환경에 적합한 인증 구조
- **자동 토큰 관리:** React 프론트엔드에서 axios 인터셉터를 통한 토큰 자동 갱신 및 만료 처리
- **보안 강화:** 승인되지 않은 사용자의 로그인 차단 및 토큰에 최소 정보만 포함

### 6.2. 계층적 권한 제어
- **중앙화된 권한 로직:** `companies/utils.py`의 유틸리티 함수로 Django Admin과 API에서 동일한 권한 규칙 적용
- **세밀한 접근 제어:** 본사→협력사→판매점 계층에 따른 정밀한 데이터 접근 제어
- **일관성 보장:** ViewSet과 Admin 인터페이스에서 동일한 권한 필터링 로직 사용

### 6.3. 현대적 프론트엔드 구현
- **React SPA:** 컴포넌트 기반 모듈화된 프론트엔드 구조
- **Context API:** 전역 인증 상태 관리 및 라우트 가드 구현
- **사용자 경험 개선:** 자동 로그인 유지, 권한별 UI 조건부 렌더링

## 7. 확장성 및 미래 방향

프로젝트는 새로운 업체 유형, 사용자 역할, 주문 상태, 정책 유형 추가 등 기능적 확장을 용이하게 설계되었습니다. 또한, API 확장, 데이터베이스 확장, 성능 확장(캐싱, 비동기 처리, 로드 밸런싱)을 고려합니다.

### 7.1. 정책 관리 시스템 확장 방향

*   **리치 텍스트 에디터:** 안내사항 입력 시 WYSIWYG 에디터 도입
*   **템플릿 시스템:** 정책 HTML 생성 시 다양한 템플릿 지원
*   **버전 관리:** 정책 변경 이력 추적 및 롤백 기능
*   **승인 워크플로우:** 정책 생성/수정 시 승인 프로세스
*   **통계 대시보드:** 정책별 성과 분석 및 시각화

## 8. 결론

`DN_solution` 프로젝트는 JWT 기반 인증, 계층적 권한 제어, React SPA 프론트엔드 구현을 통해 현대적이고 확장 가능한 아키텍처를 구축했습니다. 특히 이중 사용자 검증 시스템과 중앙화된 권한 관리를 통해 보안과 일관성을 동시에 확보하였으며, 클라우드 환경에 최적화된 상태 비저장 인증으로 분산 시스템에 적합한 기반을 마련했습니다. 

스마트기기 판매 정책 관리 시스템의 체계적인 구현과 함께, 계층별 업체 관리의 정밀한 접근 제어를 통해 복잡한 비즈니스 요구사항을 효과적으로 지원하며, 미래의 기술적 변화와 사업 확장에 유연하게 대응할 수 있는 견고한 플랫폼을 제공합니다.
